<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestor Despensa</title>
    <link rel="manifest" href="manifest.json">
    <!-- Librer√≠as Externas -->
    <script src="https://unpkg.com/html5-qrcode"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root { --primary: #2e7d32; --accent: #4caf50; --bg: #f8f9fa; }
        body { font-family: 'Segoe UI', Roboto, sans-serif; margin: 0; background: var(--bg); padding-bottom: 70px; }
        
        /* Header */
        .app-bar { background: var(--primary); color: white; padding: 15px; text-align: center; font-size: 1.2rem; font-weight: bold; position: sticky; top: 0; z-index: 100; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }

        /* Vistas */
        .view { display: none; padding: 15px; animation: fadeIn 0.3s; }
        .view.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* Tarjetas de Inventario */
        .card { background: white; border-radius: 12px; padding: 15px; margin-bottom: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); position: relative; }
        .product-img { width: 100%; height: 150px; object-fit: cover; border-radius: 8px; margin-bottom: 10px; }
        .badge { padding: 4px 8px; border-radius: 4px; font-size: 0.8rem; font-weight: bold; }
        .badge-danger { background: #ffebee; color: #c62828; }
        .badge-warning { background: #fff3e0; color: #ef6c00; }

        /* Formulario */
        label { display: block; margin-top: 10px; font-weight: bold; color: #555; }
        input, textarea { width: 100%; padding: 12px; margin-top: 5px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; font-size: 1rem; }
        .btn-scan { background: #1976d2; color: white; padding: 10px; border: none; border-radius: 8px; margin-top: 5px; width: 100%; }
        .btn-save { background: var(--primary); color: white; padding: 15px; border: none; border-radius: 8px; width: 100%; margin-top: 20px; font-size: 1.1rem; }

        /* Navegaci√≥n Inferior */
        .bottom-nav { position: fixed; bottom: 0; width: 100%; background: white; display: flex; justify-content: space-around; padding: 10px 0; border-top: 1px solid #ddd; box-shadow: 0 -2px 10px rgba(0,0,0,0.1); }
        .nav-item { border: none; background: none; color: #757575; display: flex; flex-direction: column; align-items: center; font-size: 0.8rem; flex: 1; }
        .nav-item.active { color: var(--primary); }
        .nav-item i { font-size: 1.4rem; margin-bottom: 4px; }

        /* Esc√°ner */
        #scanner-container { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: black; z-index: 200; }
        #reader { width: 100%; height: 80%; }
    </style>
</head>
<body>

    <div class="app-bar" id="app-title">Mi Despensa</div>

    <!-- Vista: Inventario -->
    <section id="view-home" class="view active">
        <h3>üì¶ Productos en Bodega</h3>
        <div id="inventory-list"></div>
    </section>

    <!-- Vista: Agregar -->
    <section id="view-add" class="view">
        <div class="card">
            <h3>Registrar Compra</h3>
            
            <label>C√≥digo de Barras</label>
            <div style="display: flex; gap: 5px;">
                <input type="text" id="barcode" placeholder="Manual o escaneado">
                <button class="btn-scan" onclick="startScanner()" style="width: 50px;"><i class="fas fa-barcode"></i></button>
            </div>

            <label>Fecha de Vencimiento</label>
            <input type="date" id="expiryDate">

            <label>Foto del Producto</label>
            <input type="file" id="photo" accept="image/*" capture="environment">

            <label>Notas / Nombre</label>
            <textarea id="notes" rows="3" placeholder="Ej: Leche entera 1L"></textarea>

            <button class="btn-save" onclick="saveProduct()">Guardar en Inventario</button>
        </div>
    </section>

    <!-- Vista: Alertas -->
    <section id="view-alerts" class="view">
        <h3>‚ö†Ô∏è Alertas de Vencimiento</h3>
        <div id="alerts-list"></div>
    </section>

    <!-- Contenedor del Esc√°ner (Oculto por defecto) -->
    <div id="scanner-container">
        <div id="reader"></div>
        <button class="btn-save" style="background: red;" onclick="stopScanner()">Cerrar Esc√°ner</button>
    </div>

    <!-- Navegaci√≥n Inferior -->
    <nav class="bottom-nav">
        <button class="nav-item active" onclick="showView('home')">
            <i class="fas fa-boxes-stacked"></i><span>Bodega</span>
        </button>
        <button class="nav-item" onclick="showView('add')">
            <i class="fas fa-plus-circle"></i><span>Agregar</span>
        </button>
        <button class="nav-item" onclick="showView('alerts')">
            <i class="fas fa-bell"></i><span>Alertas</span>
        </button>
    </nav>

    <script>
        let db;
        const html5QrCode = new Html5Qrcode("reader");

        // Inicializar Base de Datos
        const request = indexedDB.open("DespensaDB", 1);
        request.onupgradeneeded = e => {
            db = e.target.result;
            db.createObjectStore("products", { keyPath: "id", autoIncrement: true });
        };
        request.onsuccess = e => { 
            db = e.target.result; 
            renderInventory(); 
            checkAlerts();
        };

        // Navegaci√≥n entre vistas
        function showView(viewId) {
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(v => v.classList.remove('active'));
            document.getElementById('view-' + viewId).classList.add('active');
            event.currentTarget.classList.add('active');
            if(viewId === 'home') renderInventory();
            if(viewId === 'alerts') checkAlerts();
        }

        // L√≥gica del Esc√°ner
        function startScanner() {
            document.getElementById('scanner-container').style.display = 'block';
            html5QrCode.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 }, 
                decodedText => {
                    document.getElementById('barcode').value = decodedText;
                    stopScanner();
                    Swal.fire('Escaneado', 'C√≥digo detectado con √©xito', 'success');
                }
            );
        }

        function stopScanner() {
            html5QrCode.stop();
            document.getElementById('scanner-container').style.display = 'none';
        }

        // Guardar Producto
        function saveProduct() {
            const barcode = document.getElementById('barcode').value;
            const expiryDate = document.getElementById('expiryDate').value;
            const notes = document.getElementById('notes').value;
            const photoFile = document.getElementById('photo').files[0];

            if (!expiryDate || !photoFile) {
                return Swal.fire('Error', 'Fecha y foto son obligatorias', 'error');
            }

            const reader = new FileReader();
            reader.readAsDataURL(photoFile);
            reader.onload = function () {
                const transaction = db.transaction(["products"], "readwrite");
                transaction.objectStore("products").add({
                    barcode,
                    purchaseDate: new Date().toLocaleDateString(),
                    expiryDate,
                    notes,
                    photo: reader.result
                });
                Swal.fire('Guardado', 'Producto agregado', 'success');
                showView('home');
                // Limpiar formulario
                document.getElementById('barcode').value = '';
                document.getElementById('notes').value = '';
            };
        }

        // Renderizar Lista
        function renderInventory() {
            const list = document.getElementById('inventory-list');
            list.innerHTML = "";
            const today = new Date().setHours(0,0,0,0);

            db.transaction("products").objectStore("products").openCursor().onsuccess = e => {
                const cursor = e.target.result;
                if (cursor) {
                    const p = cursor.value;
                    const exp = new Date(p.expiryDate).getTime();
                    
                    // Solo mostrar si no ha vencido hace m√°s de 1 d√≠a o si queremos gestionarlos
                    list.innerHTML += `
                        <div class="card">
                            <img src="${p.photo}" class="product-img">
                            <strong>${p.notes || 'Sin nombre'}</strong><br>
                            <small>üì¶ Compra: ${p.purchaseDate}</small><br>
                            <small>üìÖ Vence: ${p.expiryDate}</small><br>
                            <button onclick="deleteProduct(${p.id})" style="background:#ff5252; color:white; border:none; padding:8px; border-radius:5px; margin-top:10px; width:100%">
                                <i class="fas fa-trash"></i> Desechar / Consumido
                            </button>
                        </div>
                    `;
                    cursor.continue();
                }
            };
        }

        function deleteProduct(id) {
            Swal.fire({
                title: '¬øEliminar producto?',
                text: "Esto lo quitar√° del inventario",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#2e7d32',
                confirmButtonText: 'S√≠, borrar'
            }).then((result) => {
                if (result.isConfirmed) {
                    db.transaction(["products"], "readwrite").objectStore("products").delete(id);
                    renderInventory();
                }
            });
        }

        function checkAlerts() {
            const alertsList = document.getElementById('alerts-list');
            alertsList.innerHTML = "";
            const today = new Date();
            const threeDays = 3 * 24 * 60 * 60 * 1000;

            db.transaction("products").objectStore("products").openCursor().onsuccess = e => {
                const cursor = e.target.result;
                if (cursor) {
                    const p = cursor.value;
                    const exp = new Date(p.expiryDate);
                    const diff = exp - today;

                    if (diff < 0) {
                        alertsList.innerHTML += `<div class="card badge-danger">üö® VENCIDO: ${p.notes} (${p.expiryDate})</div>`;
                    } else if (diff <= threeDays) {
                        alertsList.innerHTML += `<div class="card badge-warning">‚è≥ Vence pronto: ${p.notes} (en 3 d√≠as o menos)</div>`;
                    }
                    cursor.continue();
                }
            };
        }
    </script>
    <script>
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('sw.js');
        }
    </script>
</body>
</html>